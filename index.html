<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Melodia • AI Music Composer</title>
    <link href="https://fonts.googleapis.com/css2?family=Fraunces:wght@300;400;600;700&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/abcjs@6.2.3/dist/abcjs-basic-min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --cream: #FFF8F0;
            --dark: #1A1A1A;
            --accent: #FF6B35;
            --accent-dark: #D94E1F;
            --purple: #6A4C93;
            --teal: #2D6A6A;
            --sand: #E8DCC4;
        }

        body {
            font-family: 'DM Sans', sans-serif;
            background: var(--cream);
            color: var(--dark);
            overflow-x: hidden;
            line-height: 1.6;
        }

        /* Organic background shapes */
        .bg-shapes {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            pointer-events: none;
            overflow: hidden;
        }

        .shape {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.15;
            animation: float 20s infinite ease-in-out;
        }

        .shape1 {
            width: 600px;
            height: 600px;
            background: var(--accent);
            top: -200px;
            left: -100px;
            animation-delay: 0s;
        }

        .shape2 {
            width: 500px;
            height: 500px;
            background: var(--purple);
            bottom: -150px;
            right: -100px;
            animation-delay: 5s;
        }

        .shape3 {
            width: 400px;
            height: 400px;
            background: var(--teal);
            top: 50%;
            right: 10%;
            animation-delay: 10s;
        }

        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            33% {
                transform: translate(30px, -30px) scale(1.1);
            }
            66% {
                transform: translate(-20px, 20px) scale(0.9);
            }
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 60px 40px;
            position: relative;
            z-index: 1;
        }

        header {
            text-align: center;
            margin-bottom: 80px;
            animation: fadeInDown 0.8s ease-out;
        }

        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1 {
            font-family: 'Fraunces', serif;
            font-size: clamp(3rem, 8vw, 5.5rem);
            font-weight: 700;
            color: var(--dark);
            letter-spacing: -0.02em;
            margin-bottom: 20px;
            line-height: 1.1;
        }

        .subtitle {
            font-size: 1.3rem;
            color: #666;
            font-weight: 400;
            max-width: 600px;
            margin: 0 auto;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1.2fr;
            gap: 60px;
            align-items: start;
            animation: fadeIn 1s ease-out 0.3s backwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        /* Control Panel */
        .control-panel {
            background: white;
            border-radius: 30px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
            border: 2px solid rgba(0, 0, 0, 0.05);
            position: sticky;
            top: 40px;
        }

        .panel-title {
            font-family: 'Fraunces', serif;
            font-size: 2rem;
            margin-bottom: 10px;
            color: var(--dark);
        }

        .panel-subtitle {
            color: #999;
            margin-bottom: 40px;
            font-size: 0.95rem;
        }

        .input-group {
            margin-bottom: 35px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--dark);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        input[type="text"],
        input[type="number"] {
            width: 100%;
            padding: 18px 22px;
            border: 2px solid #E0E0E0;
            border-radius: 16px;
            font-size: 1.1rem;
            font-family: 'DM Sans', sans-serif;
            transition: all 0.3s ease;
            background: #FAFAFA;
        }

        input[type="text"]:focus,
        input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
            background: white;
            box-shadow: 0 0 0 4px rgba(255, 107, 53, 0.1);
        }

        /* Custom range slider */
        .range-container {
            position: relative;
            padding-top: 10px;
        }

        input[type="range"] {
            width: 100%;
            height: 8px;
            border-radius: 8px;
            background: linear-gradient(to right, var(--accent) 0%, var(--accent) 50%, #E0E0E0 50%, #E0E0E0 100%);
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
            transition: all 0.2s ease;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.15);
            box-shadow: 0 6px 16px rgba(255, 107, 53, 0.5);
        }

        input[type="range"]::-moz-range-thumb {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: none;
            box-shadow: 0 4px 12px rgba(255, 107, 53, 0.4);
        }

        .range-value {
            display: inline-block;
            margin-top: 12px;
            font-weight: 600;
            color: var(--accent);
            font-size: 1.1rem;
        }

        .generate-btn {
            width: 100%;
            padding: 22px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
            color: white;
            border: none;
            border-radius: 18px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'DM Sans', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 10px 30px rgba(255, 107, 53, 0.3);
            position: relative;
            overflow: hidden;
        }

        .generate-btn:before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .generate-btn:hover:before {
            width: 300px;
            height: 300px;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(255, 107, 53, 0.4);
        }

        .generate-btn:active {
            transform: translateY(0);
        }

        .generate-btn:disabled {
            background: #CCC;
            cursor: not-allowed;
            box-shadow: none;
        }

        .generate-btn span {
            position: relative;
            z-index: 1;
        }

        /* Output Section */
        .output-section {
            animation: fadeIn 1s ease-out 0.5s backwards;
        }

        .output-card {
            background: white;
            border-radius: 30px;
            padding: 50px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
            border: 2px solid rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
            min-height: 400px;
            display: flex;
            flex-direction: column;
        }

        .output-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #F0F0F0;
        }

        .output-title {
            font-family: 'Fraunces', serif;
            font-size: 1.8rem;
            color: var(--dark);
        }

        .status-badge {
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .status-ready {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .status-generating {
            background: #FFF3E0;
            color: #F57C00;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.6;
            }
        }

        .status-error {
            background: #FFEBEE;
            color: #C62828;
        }

        /* Music visualization */
        #music-notation {
            margin: 30px 0;
            padding: 30px;
            background: #FAFAFA;
            border-radius: 20px;
            min-height: 250px;
            overflow-x: auto;
        }

        /* Audio controls */
        .audio-controls {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 16px 32px;
            border: 2px solid var(--dark);
            background: transparent;
            color: var(--dark);
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'DM Sans', sans-serif;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .control-btn:hover {
            background: var(--dark);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .control-btn.primary {
            background: var(--purple);
            color: white;
            border-color: var(--purple);
        }

        .control-btn.primary:hover {
            background: #543875;
            border-color: #543875;
        }

        .control-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 120px;
            height: 120px;
            margin-bottom: 30px;
            opacity: 0.3;
        }

        .empty-state h3 {
            font-family: 'Fraunces', serif;
            font-size: 1.8rem;
            margin-bottom: 15px;
            color: #666;
        }

        .empty-state p {
            font-size: 1.1rem;
        }

        /* Loading animation */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 40px;
            }

            .control-panel {
                position: static;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 40px 20px;
            }

            h1 {
                font-size: 2.5rem;
            }

            .control-panel,
            .output-card {
                padding: 30px;
                border-radius: 20px;
            }

            .audio-controls {
                flex-direction: column;
            }

            .control-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: #F0F0F0;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent);
            border-radius: 5px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-dark);
        }

        .creator-credit {
            text-align: center;
            margin-bottom: 32px;
            font-size: 1.25rem;
            font-family: 'Fraunces', serif;
            color: var(--accent);
            background: #fff3e0;
            border-radius: 18px;
            padding: 18px 0;
            font-weight: 700;
            letter-spacing: 0.03em;
            box-shadow: 0 4px 16px rgba(255,107,53,0.08);
        }
    </style>
</head>
<body>
    <!-- Background shapes -->
    <div class="bg-shapes">
        <div class="shape shape1"></div>
        <div class="shape shape2"></div>
        <div class="shape shape3"></div>
    </div>

    <div class="container">
        <header>
            <h1>Melodia</h1>
            <p class="subtitle">Compose beautiful melodies with AI. Start with a note, shape the journey.</p>
        </header>

        <!-- Creator credit -->
        <div class="creator-credit">
            <span>Made by <strong>Habib Ghulam Bheek</strong></span>
        </div>
        
        <div class="main-content">
            <!-- Control Panel -->
            <div class="control-panel">
                <h2 class="panel-title">Create Music</h2>
                <p class="panel-subtitle">Set your starting note and composition length</p>

                <div class="input-group">
                    <label for="startChar">Starting Character</label>
                    <input 
                        type="text" 
                        id="startChar" 
                        placeholder="e.g., X, C, D, E"
                        maxlength="1"
                        value="X"
                    >
                    <small style="display: block; margin-top: 8px; color: #999;">ABC notation character (X, C, D, E, etc.)</small>
                </div>

                <div class="input-group">
                    <label for="length">Sequence Length: <span class="range-value" id="lengthValue">500</span></label>
                    <div class="range-container">
                        <input 
                            type="range" 
                            id="length" 
                            min="100" 
                            max="2000" 
                            value="500"
                            step="50"
                        >
                    </div>
                    <small style="display: block; margin-top: 8px; color: #999;">Longer sequences create more complex compositions</small>
                </div>

                <button class="generate-btn" id="generateBtn">
                    <span>Generate Music</span>
                </button>
            </div>

            <!-- Output Section -->
            <div class="output-section">
                <div class="output-card">
                    <div class="output-header">
                        <h3 class="output-title">Your Composition</h3>
                        <span class="status-badge status-ready" id="statusBadge">Ready</span>
                    </div>

                    <div id="outputContent">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9 18V5l12-2v13"></path>
                                <circle cx="6" cy="18" r="3"></circle>
                                <circle cx="18" cy="16" r="3"></circle>
                            </svg>
                            <h3>No music yet</h3>
                            <p>Create your first composition to see it here</p>
                        </div>
                    </div>

                    <div id="music-notation" style="display: none;"></div>

                    <div class="audio-controls" id="audioControls" style="display: none;">
                        <button class="control-btn primary" id="playBtn">
                            <span>▶</span> Play
                        </button>
                        <button class="control-btn" id="pauseBtn" disabled>
                            <span>⏸</span> Pause
                        </button>
                        <button class="control-btn" id="stopBtn" disabled>
                            <span>⏹</span> Stop
                        </button>
                        <button class="control-btn" id="downloadBtn">
                            <span>⬇</span> Download MIDI
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

     <script>
        // Configuration
        const API_URL = 'http://localhost:8000/generate';

        // DOM Elements
        const startCharInput = document.getElementById('startChar');
        const lengthInput = document.getElementById('length');
        const lengthValue = document.getElementById('lengthValue');
        const generateBtn = document.getElementById('generateBtn');
        const statusBadge = document.getElementById('statusBadge');
        const outputContent = document.getElementById('outputContent');
        const musicNotation = document.getElementById('music-notation');
        // global controls removed in favour of per-tune controls

        // State
        let tunes = [];                // array of ABC strings
        let visualObjs = [];           // visual object per tune
        let synths = {};               // synth instance per tune id
        let playingTuneId = null;

        // Update range slider value display
        lengthInput.addEventListener('input', (e) => {
            const value = e.target.value;
            lengthValue.textContent = value;
            
            // Update gradient
            const percentage = ((value - 100) / (2000 - 100)) * 100;
            e.target.style.background = `linear-gradient(to right, var(--accent) 0%, var(--accent) ${percentage}%, #E0E0E0 ${percentage}%, #E0E0E0 100%)`;
        });

        // Generate music
        async function generateMusic() {
            const startChar = startCharInput.value.trim();
            const length = parseInt(lengthInput.value);

            if (!startChar) {
                alert('Please enter a starting character');
                return;
            }

            // Update UI
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<span class="loader"></span><span style="margin-left: 10px;">Generating...</span>';
            statusBadge.className = 'status-badge status-generating';
            statusBadge.textContent = 'Generating...';
            outputContent.innerHTML = '<div class="empty-state"><p>Creating your composition...</p></div>';
            musicNotation.style.display = 'none';

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        start_char: startChar,
                        length: length
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to generate music');
                }

                const data = await response.json();

                // Normalize into an array of tunes
                if (Array.isArray(data.abc_notation)) {
                    tunes = data.abc_notation.slice();
                } else if (typeof data.abc_notation === 'string') {
                    tunes = [data.abc_notation];
                } else {
                    throw new Error('Unexpected API response format');
                }

                console.log('Received ABC notation array:', tunes);

                // Display the list of tunes (each separately)
                displayMusicList(tunes);

                // Update UI
                statusBadge.className = 'status-badge status-ready';
                statusBadge.textContent = 'Ready';

            } catch (error) {
                console.error('Error:', error);
                statusBadge.className = 'status-badge status-error';
                statusBadge.textContent = 'Error';
                outputContent.innerHTML = `
                    <div class="empty-state">
                        <h3>Something went wrong</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 10px; font-size: 0.9rem;">Make sure the API server is running at ${API_URL}</p>
                    </div>
                `;
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<span>Generate Music</span>';
            }
        }

        // Display multiple tunes, each with its own notation and controls
        function displayMusicList(abcArray) {
            outputContent.style.display = 'block';
            outputContent.innerHTML = ''; // clear
            visualObjs = [];
            synths = {};
            playingTuneId = null;

            if (!window.ABCJS) {
                outputContent.innerHTML = '<div class="empty-state"><p style="color: #C62828;">ABC.js library not loaded</p></div>';
                return;
            }

            abcArray.forEach((abc, idx) => {
                const tuneId = `tune-${idx}`;

                // Create card for each tune
                const card = document.createElement('div');
                card.className = 'output-card';
                card.style.minHeight = 'auto';
                card.style.marginBottom = '16px';

                const header = document.createElement('div');
                header.className = 'output-header';

                const title = document.createElement('h3');
                title.className = 'output-title';
                title.textContent = `Composition #${idx + 1}`;

                const actionsWrap = document.createElement('div');

                // Buttons: play, pause, stop, download
                const playBtn = document.createElement('button');
                playBtn.className = 'control-btn primary';
                playBtn.textContent = '▶ Play';
                playBtn.id = `${tuneId}-play`;

                const pauseBtn = document.createElement('button');
                pauseBtn.className = 'control-btn';
                pauseBtn.textContent = '⏸ Pause';
                pauseBtn.id = `${tuneId}-pause`;
                pauseBtn.disabled = true;

                const stopBtn = document.createElement('button');
                stopBtn.className = 'control-btn';
                stopBtn.textContent = '⏹ Stop';
                stopBtn.id = `${tuneId}-stop`;
                stopBtn.disabled = true;

                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'control-btn';
                downloadBtn.textContent = '⬇ Download MIDI';
                downloadBtn.id = `${tuneId}-download`;

                actionsWrap.appendChild(playBtn);
                actionsWrap.appendChild(pauseBtn);
                actionsWrap.appendChild(stopBtn);
                actionsWrap.appendChild(downloadBtn);

                header.appendChild(title);
                header.appendChild(actionsWrap);

                const notationDiv = document.createElement('div');
                notationDiv.id = tuneId;
                notationDiv.style.padding = '18px';
                notationDiv.style.background = '#FAFAFA';
                notationDiv.style.borderRadius = '12px';
                notationDiv.style.marginTop = '12px';

                card.appendChild(header);
                card.appendChild(notationDiv);

                outputContent.appendChild(card);

                // Render ABC into this tune's div
                try {
                    const vis = window.ABCJS.renderAbc(tuneId, abc, {
                        responsive: "resize",
                        staffwidth: Math.max(notationDiv.offsetWidth - 40, 300),
                    });
                    if (vis && vis.length > 0) {
                        visualObjs[idx] = vis[0];
                        console.log(`Rendered tune ${idx}`);
                    } else {
                        visualObjs[idx] = null;
                        notationDiv.innerHTML = `<p style="color: #C62828;">Could not render notation for this tune.</p>`;
                    }
                } catch (err) {
                    console.error('Render error for tune', idx, err);
                    visualObjs[idx] = null;
                    notationDiv.innerHTML = `<p style="color: #C62828;">Error rendering music notation: ${err.message}</p>`;
                }

                // Wire up controls for this tune
                playBtn.addEventListener('click', () => playTune(idx, playBtn, pauseBtn, stopBtn));
                pauseBtn.addEventListener('click', () => pauseTune(idx, playBtn, pauseBtn, stopBtn));
                stopBtn.addEventListener('click', () => stopTune(idx, playBtn, pauseBtn, stopBtn));
                downloadBtn.addEventListener('click', () => downloadTune(idx));
            });
        }

        // Play a specific tune
        async function playTune(idx, playBtn, pauseBtn, stopBtn) {
            if (!visualObjs[idx]) {
                alert('This tune cannot be played (no visual object).');
                return;
            }

            // If another tune is playing, stop it first
            if (playingTuneId !== null && playingTuneId !== idx) {
                const prevSynth = synths[playingTuneId];
                if (prevSynth) {
                    try { prevSynth.stop(); } catch (_) {}
                }
                // Optionally update previous buttons; simpler to reload UI on stop
            }

            try {
                let synth = synths[idx];
                if (!synth) {
                    if (!window.ABCJS.synth || !window.ABCJS.synth.CreateSynth) {
                        throw new Error('ABC.js synth not available');
                    }
                    synth = new window.ABCJS.synth.CreateSynth();
                    synths[idx] = synth;

                    await synth.init({
                        visualObj: visualObjs[idx],
                        options: {
                            ended: () => {
                                console.log(`Playback finished for tune ${idx}`);
                                playingTuneId = null;
                                playBtn.disabled = false;
                                pauseBtn.disabled = true;
                                stopBtn.disabled = true;
                            }
                        }
                    });
                    await synth.prime();
                }

                await synth.start();
                playingTuneId = idx;
                playBtn.disabled = true;
                pauseBtn.disabled = false;
                stopBtn.disabled = false;

            } catch (error) {
                console.error('Error playing tune:', error);
                alert(`Error playing music: ${error.message}\n\nTry generating the music again.`);
                playBtn.disabled = false;
                pauseBtn.disabled = true;
                stopBtn.disabled = true;
            }
        }

        // Pause tune
        function pauseTune(idx, playBtn, pauseBtn, stopBtn) {
            const synth = synths[idx];
            if (synth) {
                try {
                    synth.pause();
                    playingTuneId = null;
                    playBtn.disabled = false;
                    pauseBtn.disabled = true;
                } catch (err) {
                    console.error('Pause error:', err);
                }
            }
        }

        // Stop tune
        function stopTune(idx, playBtn, pauseBtn, stopBtn) {
            const synth = synths[idx];
            if (synth) {
                try {
                    synth.stop();
                } catch (err) {
                    console.error('Stop error:', err);
                }
            }
            playingTuneId = null;
            playBtn.disabled = false;
            pauseBtn.disabled = true;
            stopBtn.disabled = true;
        }

        // Download MIDI (per tune) with fallback to raw ABC if MIDI generation not available
        function downloadTune(idx) {
            const abcText = tunes[idx];
            if (!abcText) {
                alert('No music to download for this tune.');
                return;
            }

            // Helper: extract usable href or create blob URL
            function extractMidiHref(result) {
                if (!result) return null;

                // Direct data/blob URL string
                if (typeof result === 'string') {
                    const trimmed = result.trim();
                    if (trimmed.startsWith('data:') || trimmed.startsWith('blob:')) return { href: trimmed, revoke: false };
                    // Some ABCJS versions return an HTML string containing an <a> tag
                    if (trimmed.startsWith('<')) {
                        const tmp = document.createElement('div');
                        tmp.innerHTML = trimmed;
                        const a = tmp.querySelector('a');
                        if (a && a.href) return { href: a.href, revoke: false };
                        // fallback regex
                        const m = trimmed.match(/href=(["'])(.*?)\1/);
                        if (m && m[2]) return { href: m[2], revoke: false };
                    }
                    return null;
                }

                // DOM element (some ABCJS versions)
                if (result instanceof HTMLElement) {
                    const a = result.querySelector('a');
                    if (a && a.href) return { href: a.href, revoke: false };
                    return null;
                }

                // Binary data (ArrayBuffer / Uint8Array) -> create blob URL
                if (result instanceof ArrayBuffer || result instanceof Uint8Array) {
                    const array = result instanceof Uint8Array ? result.buffer : result;
                    const blob = new Blob([array], { type: 'audio/midi' });
                    const url = URL.createObjectURL(blob);
                    return { href: url, revoke: true };
                }

                // Unknown
                return null;
            }

            try {
                // Try MIDI via ABCJS if available
                if (window.ABCJS && window.ABCJS.synth && typeof window.ABCJS.synth.getMidiFile === 'function') {
                    let midiResult;
                    try {
                        // try raw abc first (some versions accept string)
                        midiResult = window.ABCJS.synth.getMidiFile(abcText);
                    } catch (e) {
                        // try visual object fallback
                        if (visualObjs[idx]) {
                            try { midiResult = window.ABCJS.synth.getMidiFile(visualObjs[idx]); } catch (e2) { midiResult = null; }
                        } else {
                            midiResult = null;
                        }
                    }

                    const extracted = extractMidiHref(midiResult);
                    if (extracted && extracted.href) {
                        const a = document.createElement('a');
                        a.href = extracted.href;
                        a.download = `melodia-${idx + 1}-${Date.now()}.mid`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        if (extracted.revoke) {
                            // revoke after a short delay to ensure download started
                            setTimeout(() => URL.revokeObjectURL(extracted.href), 2000);
                        }
                        console.log('MIDI downloaded for tune', idx);
                        return;
                    }
                }

                // Fallback: download ABC text as .abc file
                const blob = new Blob([abcText], { type: 'text/plain;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `melodia-${idx + 1}-${Date.now()}.abc`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                console.log('ABC file downloaded as fallback for tune', idx);

            } catch (error) {
                console.error('Error downloading tune', idx, error);
                alert(`Error creating download file: ${error.message}`);
            }
        }

        // Event listeners
        generateBtn.addEventListener('click', generateMusic);

        // Allow Enter key to generate
        startCharInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') generateMusic();
        });

        console.log('Music Generator initialized (multi-tune + per-tune download enabled)');
    </script>
</body>
</html>